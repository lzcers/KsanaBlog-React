---
Title: ESP8266 天猫精灵接入
Tags: 硬件
PublishDate: 2019/8/31 20:00:11
---

一开始生起想要玩一玩 ESP8266 的念头时，目的就是为了能够将自己的硬件设备接入天猫精灵，通过语音来控制。如果只是做一个无聊的温度显示器，说实话我才不想折腾。最终经过权衡与思考，我还是决定继续朝着我最初的设想前进，即将自制的硬件设备接入天猫精灵。

上回也提到接入天猫精灵所遇到的困难，其中最重要的就是公网 IP 的服务器，所以我最终还是购买了 288RMB 的套路云轻量级主机，当然，这也有其他考量，比如梯子的需求。

接入天猫精灵有**两种途径**：

1. **智能家居-云云自助接入**
2. **自定义技能+动态内容接入**

这两种我都有尝试，其中第一种是最难搞的，但反而是可玩性最弱的，一顿折腾下来只觉坑爹！

## 接入的准备

1. 一台公网可访问的服务器 
2. 一个 ESP8266，别的什么可联网的硬件开发板子都行
3. 一个域名
4. https 证书

## 云云接入方案

这是最难搞的方案，因为你既要充当设备厂商的云服务器做鉴权与授权，又要实现开发者网关，接收控制指令。

![img](https://ksana.oss-cn-shenzhen.aliyuncs.com/articles/imgs/ESP8266天猫精灵接入/LB1VWxkblDH8KJjSspnXXbNAVXa.png)

如图所示，我们要实现第三方设备控制云服务器，这也就意味着我们需要一台能够在公网被天猫精灵 NLU 访问的服务器，同时这台服务器必须是 https 可访问的，证书要可信，不能是自己签名的证书。

我已经买了套路云的主机，绑上自己的域名，开启 HTTPS 服务器，证书怎么搞？用 **[acme.sh](https://github.com/Neilpang/acme.sh)** 即可，搭建 Web 服务器这个轻车熟路了就不多说。搭好服务器之后我们就要开始实现 API 接口与 天猫精灵 NLU 对接。

### 第一步先实现 OAuth2 的授权协议

参考官方文档 [接入方式及流程](https://doc-bot.tmall.com/docs/doc.htm?spm=0.7629140.0.0.4f5c1780cDZUgT&treeId=393&articleId=106999&docType=1) 实现，事实上我们并不需要真正实现 OAuth2 协议的内容，我们只要能够根据请求返回相应的参数即可，毕竟接口的实现对外部是不可见的，只要保证输入参符合天猫精灵 API 请求的规范，所以实现怎么简单怎么来，自己造 Mock 数据搞定即可，至于写到数据库里、生成 `code`、`access_token`、这些我们统统自己写死，谁让我们既当爹（设备控制云）又当妈（开发者网关）呢。

### 实现开发者网关

开发者网关主要用于响应天猫精灵传递过来的指令，根据官方的 **[智能家居接入协议](https://doc-bot.tmall.com/docs/doc.htm?spm=0.7629140.0.0.3ac91780LIy0zW&treeId=393&articleId=108264&docType=1)** 撸代码即可，但是有一点，我们的开发服务器与设备都是在内网的，所以，要让外网访问到我们并将指令发送过来完成请求与应答还需要做一件事情，那就是内网穿透，因为梯子使用了 V2Ray 的缘故，而这个神奇的东西是可以做内网穿透工具的，经过一番折腾实现了内网穿透，终于扫清了障碍。

一旦授权通过，我们就会收到**设备发现**的指令，根据官方文档，我们自己造一个数据，告诉天猫精灵我们的 ESP8266 叫啥名，什么用途、类型、有啥属性、动作等，这样，我们就可在设备列表中看到我们的设备，这样就完成了接入。

然后坑爹的来了，其他的控制指令，查询指令我们都只能根据协议上指定的范围来？？？？？

这就跟我想的不一样了小老弟，我本来是希望天猫精灵直接传递 NLP 处理之后的信息给我，比意图，实体之类的信息，怎么响应处理我自己来，这才好玩啊，经过一番折腾后，我们实现了几个简单的查询指令，然后弃坑了。

## 自定义技能 + 动态内容接入

其实要实现我想的那种接入，只需要考虑自定义内容即可，我们在平台上配置完意图、实体、然后配一些话术，填上我们的动态内容获取 API 地址，天猫精灵就会将 NLP 解析后的信息发送至我们填入的接口。

[官方 webHook 实现参考文档](https://doc-bot.tmall.com/docs/doc.htm?spm=0.7629140.0.0.470b1780qMRv4T&treeId=393&articleId=106952&docType=1)

这个就简单很多，还有一点要注意的是，请求响应不能超过 2s 否则就会出现`一不留神连你的吩咐都听岔了`这样的答复。

## 与板子的通信方案

有一点可能没说，我们怎么和 esp8266 通信获取传感器的温度、湿度、PPM ？首先，我们的板子是带 wifi 功能的，因此在一个局域网内，我们可以跑个 web 服务之类的来搞，但这太重了， 这里我用了 MQTT 来通信，MQTT 的 Broker 用了阿里云物联网的微消息队列，这个虽然有些折腾，但还是学了些东西也不错了，认真看阿里云官方提供的文档还是能搞通的，坑点不多。

## 最后上图

![1567255107837](https://ksana.oss-cn-shenzhen.aliyuncs.com/articles/imgs/ESP8266天猫精灵接入/1567255107837.png)