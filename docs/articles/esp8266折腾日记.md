---
Title: ESP8266 折腾日记
Tags: 硬件
PublishDate: 2019/8/10 23:25:11
---

为了保护好家里的植物萌生了开发一套自动浇水系统的念头，再结合最近养了只猫（天猫精灵）脑子里念头一下涌出许多，做一个家庭环境监控系统接入天猫精灵语音控制怎样？「天猫精灵，家里环境状况如何？」，「温度 27 湿度 55 污染 0 状况良好」，这样的想法似乎很美好啊。

说干就干，本来想最近新出的树莓派4，但是想想之前吃灰的经历便作罢，又仔细找了找一些单片机开发的资料发现了 esp8266 这块神奇的芯片，严格来说这不是单片机，而是一块 WIFI 模块，但是自带一个 32 位的 MCU 令它在国内外都非常火，我们甚至可以用 microPython 来做开发，简直不要太友好了。

限于手中的材料，我先做了个简单的温度、湿度显示器练手，毕竟我是一个从未接触过硬件的前端开发，这种硬件活还是有点硬了。做好之后便想着如何连接到天猫精灵，看了天猫精灵的接入文档后发现需要一个公网的机器来做 oAuth2 鉴权认证以及处理语音解析结果，最后才对设备下达控制命令。可是阿里云的 ECS 主机 500 一年啊大兄弟，这可比物料成本贵多了，劝退，以后考虑吧。 

## 物料准备

1. esp8266EX-ES12E （型号很多，淘宝上看看差别吧）
2. 面包板
3. 杜邦线，公公，公母，母母都要若干
4. DHT11 温度湿度传感器 （继承至离职的同事）
5. max7219 8*8 点阵屏 4 块 （也是继承来的，并不是必须品）

## 固件烧入

1. 在 microPython 官网找到对应板子的 bin 文件下载
2. 安装 usb转串口的驱动
3. 下载 esptool.py 烧入固件

## 其他设置

1. 通过 xshell 或者 pioccom 等串口调试工具连接串口，设置好波特率连上去

2. 不出意外的话就会看到 microPython 的 REPL 界面了

3. 接下来就是看 microPython 设置 AP，连入 wifi 

   ```python
   # 连接 wifi
   import network
   wlan = network.WLAN(network.STA_IF)
   wlan.active(True)
   wlan.scan()
   wlan.isconnected()
   wlan.connect('WIFI 热点', '密码')
   wlan.config('mac')
   wlan.ifconfig()
   print(wlan)
   # 开启 AP
   import network
   ap = network.WLAN(network.AP_IF)
   ap.active(True)
   ap.config(essid='ee', channel=11, authmode=network.AUTH_WPA_WPA2_PSK, password='password') 
   print(ap)
   ```

   这两个可以同时开启，连接 WIFI 的同时还能开着热点，很强

4. 启动 microPython 的 webREPL 并通过浏览器连接，接下来就可以摆脱串口调试工具了，但是串口直连会快些

   ```python
   # webrepl 设置
   import webrepl_setup
   # 启动 webrepl
   import webrepl
   webrepl.start() 
   ```

   

## 编码

板子启动会自动运行 boot.py 里的代码，类似于 main 函数入口，关于系统的文件目录我们可以命令来查看 

```python
import os
# 显示当前目录下的文件，不出意外可以看到 boot.py
os.listdir()
```

我们可以自己写 python 代码，通过 webREPL 界面将文件上传，在 boot.py 里导入模块并执行可以起到开机自动运行的效果。

具体对硬件以及传感器的操作可以看 microPython 的官方文档及互联网资料，一大把随便找找

## 效果

效果不错，我做了一个新的摆件，接上移动电源够跑一周吧？新的吃灰方式诞生了，感觉海星。

![1565452184704](https://ksana.oss-cn-shenzhen.aliyuncs.com/articles/imgs/1565452184704.png)

![img](https://ksana.oss-cn-shenzhen.aliyuncs.com/articles/imgs/dht11.png)