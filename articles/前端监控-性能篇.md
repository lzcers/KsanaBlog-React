---
Title: 前端监控-性能篇
tags: 前端
PublishDate: 2018/7/10 18:09:14
---

## 背景

最近项目痛点，就是应用在我们的设备上好好的，怎么一到用户那就反馈各种问题呢？这个痛点相信不止我一个人遇到，甩给测试去控制那也不容易啊，如果公司穷，测试设备覆盖不全就更痛苦了，而且用户对问题无法给出技术性的描述，作为开发只能靠经验推断，心累。

于是最近几天我就研究了下**前端监控**相关的内容，写了个简单的信息采集工具，当然，业界已经有许多现成的方案了，如 funDebug、bugsnag、BadJS、betterjs 等，但我就是想自己造一个轮子！

好像代码量不多？我上我也行（错觉），自己造一个学习下（最重要的理由）。

GitHub 链接：[fe-monitor](https://github.com/lzcers/femonitor/tree/master/src)

## 设计要求

- 易于扩展，可自定义

  我哪天想到啥新的监控点可以直接扩展，比如说不仅仅是性能监控，js 错误监控之类的，订单请求也可纳入监控范围啊，不是偶尔掉单吗？前端也可以抓点数据嘛。还有用户行为路径之类的数据。

- 无侵入，小侵入

  最好简单引入个 sdk 就行，尽可能不要埋点

- 适用不同框架

  比如连接 Vue.config.errorHandle 

## 模块

- 信息采集
- 信息上报 
- 信息分析
- 报警
- 信息可视化

在前端主要做的就是信息采集和信息上报，数据到了后端存储后再做信息分析，报警，可视化之类的工作，那么问题来了，首先要确定是到底要**采集哪些数据**？采用什么**上报策略**？所有数据一律上报显然不现实，没那必要，也没那么大存储空间。

## 信息采集

首先，我们采集信息的目的是什么？在这里我希望能够**主动发现问题**，**了解我们的应用在客户那的运行情况**，大部分问题产生的原因主要是这些

* 资源文件加载出错
* 接口访问错误
* 服务器错误
* 前端代码错误
* 兼容性问题（css或是js）
* 用户操作出错

更进一步我们可以监控用户的行为路径，运营数据等，优化并提高转化率。

最后根据我们的需求整理来看，主要监控的就是这几类：

**网络请求监控**

* web 资源的加载速度 （performance.getEntriesByType('resource')）
* HTTP 资源加载异常 （addEventListener(error)）
* 异步请求 API 调用的成功率以及响应延时（劫持掉原生的 XHR 和 fetch）

**页面渲染 / 交互监控**

* JS 运行异常 （onerror等）
* 页面性能 （performance.timing）

**用户环境信息**
* IP (需要借助第三方服务，或者自己实现)
* 浏览器 （UA 不准）
* 操作系统（UA 不准）
* 语言 （navigator.language）

### 页面性能监控

为啥要做性能监控呢？因为性能与利益直接相关。

> 有数据调查显示：当Google 延迟 400ms时，搜索量下降 0.59%、Bing 延迟 2s，收入下降 4.3%、Yahoo 延迟 400ms，流量下降 5-9%，所以，很多公司在做用户体验分析时，第一个看的就是性能监控指标。

对前端而言，重要的性能指标有这些：

1. 白屏时间：（first Paint Time）用户打开页面到看到东西的时间
2. 首屏时间：用户首屏内容全部加载出来花费的时间
3. 用户可交互时间：从看到东西到可操作的时间
4. 总下载时间：页面所有资源都加载完成并呈现出来所花的时间
5. DNS 查询时间
6. TCP 连接建立时间
7. HTTP 请求响应时间

幸运的是，*几乎*所有这些性能指标，在 IE9 以上都可以通过一个接口拿到 `performance.timing`。

![gtmetrix](http://fex.baidu.com/img/build-performance-monitor-in-7-days/timing.png)  

根据上图所示我们可以这样计算这些性能指标

```javascript
const perf = window.performance
const timing = perf.timing
const perfInfo = {
    dns: timing.domainLookupEnd - timing.domainLookupStart, // DNS查询耗时，太长可以考虑 DNS 预解析 
    connect: timing.connectEnd - timing.connectStart, // TCP 链接耗时，服务器网络环境太水了吧？
    whtite: timing.responseStart - timing.navigationStart, // 白屏时间
    domp: timing.domComplete - timing.domInteractive, // 解析 DOM 的时间，是不是嵌套太深了？
    dom: timing.domContentLoadedEventEnd - timing.navigationStart, // dom 渲染完成时间， 可以视作用户可操作时间
    request: timing.responseEnd - timing.responseStart, // request 请求耗时
    onload: timing.loadEventEnd - timing.navigationStart // 总下载时间, 页面 onload 时间
}
```

对于首屏时间我还没找到好的方案，现在前端开发都是用各种框架来做的，不好计算呀。

后一篇再来写 JS 运行监控，这会比较麻烦，因为涉及到跨域，好像在前端凡是涉及到跨域的问题就麻烦，但是没办法，安全第一。

----

一些参考的文档：

http://www.alloyteam.com/2015/09/explore-performance/ 使用 window.performance 提供了一组精确的数据，经过简单的计算就能得出一些网页性能数据。

https://www.cnblogs.com/fsjohnhuang/p/7685144.html  前端魔法堂——异常不仅仅是try/catch

http://www.alloyteam.com/2014/03/front-end-data-monitoring/ 前端相关数据监控

http://rapheal.sinaapp.com/2014/11/06/javascript-error-monitor/ 前端代码异常监控

https://zhuanlan.zhihu.com/p/31979395 前端代码异常监控实战

https://github.com/fengyaogit123/monitor-js 轻量级前端错误监控插件

https://saijs.github.io/wiki/ JavaScript 异常档案

https://github.com/suguangwen/neky-err 前端异常捕捉

https://zhuanlan.zhihu.com/p/32262716 把前端监控做到极致

https://zhuanlan.zhihu.com/p/23310438 不可忽视的前端监控

https://blog.seosiwei.com/detail/30 performance-report页面性能、资源、错误、ajax，fetch请求上报插件

 https://zhuanlan.zhihu.com/p/35442263  前端性能监控系统开发

http://fex.baidu.com/blog/2014/05/build-performance-monitor-in-7-days/ 7 天打造前端性能监控系统

 https://zhuanlan.zhihu.com/p/35614506 Performance — 带你监控前端性能

https://zhuanlan.zhihu.com/p/33712608 开发完第一版前端性能监控系统后的总结

https://zhuanlan.zhihu.com/p/27305665 前端异常监控平台的设计思路及实现

https://zhuanlan.zhihu.com/p/32761159 2017前端监控系统探索总结

https://zhuanlan.zhihu.com/p/37298838 前端错误监控与收集探究

https://zhuanlan.zhihu.com/p/26085642 前端异常监控系统的落地
